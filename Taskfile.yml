version: '3'

vars:
  BACKEND_DIR: backend
  FRONTEND_DIR: frontend

tasks:
  dev:
    desc: Run backend and frontend locally
    deps: [db-start]
    cmds:
      - echo "ğŸš€ Starting KeywordsChat development environment..."
      - task: backend-dev &
      - task: frontend-dev

  backend-dev:
    desc: Run backend server locally
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "ğŸ”§ Starting backend on http://localhost:8000..."
      - uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

  frontend-dev:
    desc: Run frontend locally
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "ğŸ¨ Starting frontend..."
      - flutter run -d chrome

  db-start:
    desc: Start PostgreSQL database
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "ğŸ˜ Starting PostgreSQL..."
      - docker-compose up -d db
      - sleep 3
    status:
      - docker-compose ps db | grep -q "Up"

  db-stop:
    desc: Stop PostgreSQL database
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "ğŸ›‘ Stopping PostgreSQL..."
      - docker-compose stop db

  db-reset:
    desc: Reset database (destroy and recreate)
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "âš ï¸  Resetting database..."
      - docker-compose down -v
      - docker-compose up -d db
      - sleep 3
      - task: migrate

  migrate:
    desc: Run database migrations
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "ğŸ”„ Running migrations..."
      - alembic upgrade head

  migrate-create:
    desc: Create a new migration
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "ğŸ“ Creating new migration..."
      - alembic revision --autogenerate -m "{{.CLI_ARGS}}"

  setup:
    desc: Initial setup (install dependencies and setup database)
    cmds:
      - task: backend-setup
      - task: frontend-setup
      - task: db-start
      - task: migrate

  backend-setup:
    desc: Setup backend dependencies
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "ğŸ“¦ Installing backend dependencies..."
      - pip install -r requirements.txt

  frontend-setup:
    desc: Setup frontend dependencies
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "ğŸ“¦ Installing frontend dependencies..."
      - flutter pub get

  test:
    desc: Run all tests
    cmds:
      - task: backend-test
      - task: frontend-test

  backend-test:
    desc: Run backend tests
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "ğŸ§ª Running backend tests..."
      - pytest

  frontend-test:
    desc: Run frontend tests
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "ğŸ§ª Running frontend tests..."
      - flutter test

  clean:
    desc: Clean all build artifacts and caches
    cmds:
      - echo "ğŸ§¹ Cleaning build artifacts..."
      - rm -rf {{.BACKEND_DIR}}/__pycache__
      - rm -rf {{.BACKEND_DIR}}/.pytest_cache
      - rm -rf {{.FRONTEND_DIR}}/build
      - rm -rf {{.FRONTEND_DIR}}/.dart_tool
      - docker-compose -f {{.BACKEND_DIR}}/docker-compose.yml down

  logs:
    desc: View backend logs
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - docker-compose logs -f

  build:
    desc: Build production artifacts
    cmds:
      - task: backend-build
      - task: frontend-build

  backend-build:
    desc: Build backend Docker image
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "ğŸ³ Building backend Docker image..."
      - docker build -t keywordschat-backend .

  frontend-build:
    desc: Build frontend for production
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "ğŸ—ï¸  Building frontend..."
      - flutter build web --release

  check:
    desc: Check if environment is properly configured
    cmds:
      - echo "ğŸ” Checking environment..."
      - cmd: test -f {{.BACKEND_DIR}}/.env
        msg: "âŒ backend/.env not found! Copy .env.example to .env"
      - cmd: which docker
        msg: "âŒ Docker not installed!"
      - cmd: which flutter
        msg: "âŒ Flutter not installed!"
      - cmd: which python3
        msg: "âŒ Python3 not installed!"
      - echo "âœ… Environment looks good!"

  help:
    desc: Show available tasks
    cmds:
      - task --list

